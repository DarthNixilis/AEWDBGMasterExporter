<!-- FILE: index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AEW TCG Deck Builder</title>
  <link rel="stylesheet" href="./style.css" />

  <style>
    /* Minimal safety UI if CSS fails */
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    .topbar { padding: 10px 12px; border-bottom: 1px solid rgba(0,0,0,.12); position: sticky; top: 0; background: #fff; z-index: 5; }
    .wrap { padding: 12px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    select, button { font-size: 16px; padding: 8px 10px; }
    .muted { opacity: .75; }
    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap: 10px; margin-top: 12px; }
    .card { border: 1px solid rgba(0,0,0,.12); border-radius: 10px; padding: 10px; }
    .card h4 { margin: 0 0 6px 0; font-size: 16px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(0,0,0,.12); font-size: 12px; margin-right: 6px; }
    .error-toast {
      position: fixed; left: 12px; right: 12px; bottom: 12px;
      background: #111; color: #fff; padding: 10px 12px; border-radius: 12px;
      box-shadow: 0 6px 24px rgba(0,0,0,.25); z-index: 9999;
      max-height: 45vh; overflow: auto;
    }
    .error-toast pre { white-space: pre-wrap; word-break: break-word; margin: 8px 0 0 0; font-size: 12px; opacity: .9; }
    .error-toast .hdr { display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .error-toast button { background: transparent; color: #fff; border: 1px solid rgba(255,255,255,.25); border-radius: 10px; padding: 6px 10px; }
  </style>

  <script>
    // FILE: index.html (bootstrap error surface)
    (function () {
      const state = {
        lastStatus: "",
        toastEl: null
      };

      function ensureToast() {
        if (state.toastEl) return state.toastEl;
        const el = document.createElement("div");
        el.className = "error-toast";
        el.style.display = "none";
        el.innerHTML = `
          <div class="hdr">
            <div><strong>App Error</strong> <span class="muted" id="errTime"></span></div>
            <div class="row">
              <button id="errCopy" type="button">Copy</button>
              <button id="errClose" type="button">Close</button>
            </div>
          </div>
          <div id="errMsg"></div>
          <pre id="errDetails"></pre>
        `;
        document.body.appendChild(el);
        el.querySelector("#errClose").onclick = () => { el.style.display = "none"; };
        el.querySelector("#errCopy").onclick = async () => {
          const text = [
            el.querySelector("#errMsg").textContent || "",
            el.querySelector("#errDetails").textContent || ""
          ].join("\n\n").trim();
          try {
            await navigator.clipboard.writeText(text);
            alert("Copied error details to clipboard.");
          } catch {
            alert("Copy failed. (Android clipboard can be picky.)\n\n" + text);
          }
        };
        state.toastEl = el;
        return el;
      }

      function showError(message, details) {
        try {
          const el = ensureToast();
          el.querySelector("#errTime").textContent = "· " + new Date().toLocaleTimeString();
          el.querySelector("#errMsg").textContent = message || "Unknown error";
          el.querySelector("#errDetails").textContent = details || "";
          el.style.display = "block";
        } catch (e) {
          // Last resort: alert
          alert("App Error: " + (message || "Unknown") + "\n\n" + (details || ""));
        }
      }

      function setStatus(text) {
        state.lastStatus = String(text || "");
        const node = document.getElementById("statusText");
        if (node) node.textContent = state.lastStatus;
      }

      // Expose globally so even early failures can report
      window.AEWDBG = window.AEWDBG || {};
      window.AEWDBG.showError = showError;
      window.AEWDBG.setStatus = setStatus;

      // Catch anything that would normally only be visible in console
      window.addEventListener("error", (ev) => {
        const msg = ev?.message || "Script error";
        const src = ev?.filename ? `${ev.filename}:${ev.lineno || 0}:${ev.colno || 0}` : "";
        showError(msg, src + (ev?.error?.stack ? "\n\n" + ev.error.stack : ""));
      });

      window.addEventListener("unhandledrejection", (ev) => {
        const reason = ev?.reason;
        const msg = (reason && (reason.message || String(reason))) || "Unhandled promise rejection";
        const details = reason?.stack ? reason.stack : "";
        showError(msg, details);
      });
    })();
  </script>
</head>

<body>
  <div class="topbar">
    <div class="row">
      <div><strong id="appTitle">Persona</strong> <span class="muted">Card Pool</span> <span class="muted">Deck</span> <span class="muted">Starting</span></div>
    </div>
    <div class="row" style="margin-top:6px;">
      <div id="statusText">Status: Loading… Sets: (loading) Cards: (loading)</div>
    </div>
  </div>

  <div class="wrap">
    <p class="muted">
      Pick a Persona. Their Starter cards (including Kit cards) will auto-load using the <code>Starting For</code> column.
      Kit cards will never appear in Card Pool.
    </p>

    <div class="row">
      <label for="personaSelect"><strong>Choose Persona:</strong></label>
      <select id="personaSelect">
        <option value="">(loading…)</option>
      </select>
      <button id="clearPersonaBtn" type="button">Clear Persona</button>
    </div>

    <p class="muted" style="margin-top:10px;">
      Card Pool excludes any card that has <code>Starting For</code> filled in (those are starters/kit/etc).
      Also excludes Kits even if you forget and label them weird.
    </p>

    <h3 style="margin:14px 0 6px 0;">Starter / Kit cards for selected Persona</h3>
    <div id="starterGrid" class="cards"></div>

    <h3 style="margin:14px 0 6px 0;">General Card Pool (no Kits, no Starters)</h3>
    <div id="poolGrid" class="cards"></div>
  </div>

  <script type="module">
    // FILE: index.html (module bootstrap)
    const { showError, setStatus } = window.AEWDBG;

    async function boot() {
      setStatus("Status: Loading… Sets: (loading) Cards: (loading)");
      try {
        // Dynamic import so we can catch module-load failures and show them on-screen
        const mod = await import("./renderer.js");
        if (!mod || typeof mod.initApp !== "function") {
          throw new Error("renderer.js loaded, but initApp() was not found.");
        }
        await mod.initApp();
      } catch (err) {
        showError("Boot failed (module load/import).", err?.stack || String(err));
        setStatus("Status: ERROR (see popup) · Sets: (loading) · Cards: (loading)");
      }
    }

    boot();
  </script>
</body>
</html>
